<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
    // 1Ô∏è‚É£ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Config (‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‚úÖ)
    const firebaseConfig = {
      apiKey: "AIzaSyDnPenoLXFdVPtUUR3z9lQACAeS6WZcyyU",
      authDomain: "dropnlock-b9699.firebaseapp.com",
      projectId: "dropnlock-b9699",
      storageBucket: "dropnlock-b9699.firebasestorage.app",
      messagingSenderId: "971185135920",
      appId: "1:971185135920:web:f208fe01f1773d257428f5",
      measurementId: "G-JV5HQTG9FB"
    };

    // ‡∏•‡∏¥‡∏á‡∏Å‡πå Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const API_URL = "https://script.google.com/macros/s/AKfycby5p-MrPS_NcSz0GSEcy5FrMfnZRB5MYrw66bWjTGeVBowfd-nXwZTUPlGA_gbS0dQUCg/exec";

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    auth.languageCode = 'th'; // ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢

    // ---------------------------------------------------------
    // 2Ô∏è‚É£ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡πÅ‡∏¢‡∏Å LINE ‡∏Å‡∏±‡∏ö Web)
    // ---------------------------------------------------------
    const isLineApp = /Line/i.test(navigator.userAgent); // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡πÑ‡∏´‡∏°?
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô LINE -> ‡∏à‡∏≥‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ (LOCAL)
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Web -> ‡∏à‡∏≥‡πÅ‡∏Ñ‡πà‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î (SESSION)
    const persistenceMode = isLineApp 
        ? firebase.auth.Auth.Persistence.LOCAL 
        : firebase.auth.Auth.Persistence.SESSION;

    auth.setPersistence(persistenceMode)
        .then(() => console.log("‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏£‡∏´‡∏±‡∏™: " + (isLineApp ? "LINE (‡∏à‡∏≥‡∏ï‡∏•‡∏≠‡∏î)" : "Web (‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)")))
        .catch(err => console.error("Persistence Error:", err));

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    let confirmationResult = null;
    let currentUserPhone = "";
    let selectedLocker = null;

    // ---------------------------------------------------------
    // 3Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô + ‡∏£‡∏∞‡∏ö‡∏ö Deep Link
    // ---------------------------------------------------------
    auth.onAuthStateChanged((user) => {
        if (user) {
            // ---> ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß <---
            currentUserPhone = user.phoneNumber;
            console.log("Logged in:", currentUserPhone);

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÅ‡∏•‡∏∞ OTP
            document.getElementById('pageLogin').classList.add('hidden');
            document.getElementById('pageOTP').classList.add('hidden');

            // ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏à‡∏≠ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Element ‡∏ô‡∏µ‡πâ)
            const welcomeUser = document.getElementById('welcomeUser');
            if(welcomeUser) welcomeUser.innerText = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: " + currentUserPhone;

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏´‡∏ô? (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å LINE)
            checkDeepLink(); 

        } else {
            // ---> ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà <---
            document.getElementById('pageLogin').classList.remove('hidden');
            document.getElementById('pageOTP').classList.add('hidden');
            document.getElementById('pageMenu').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏õ‡∏∏‡πà‡∏° Captcha
            renderRecaptcha();
        }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏á‡∏Å‡πå (‡πÄ‡∏ä‡πà‡∏ô ?page=sender)
    function checkDeepLink() {
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page');

        if (page === 'sender') {
            nav('sender'); // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏ï‡∏π‡πâ
        } else if (page === 'receiver') {
            nav('receiver'); // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        } else {
            nav('menu'); // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
        }
    }

    // ---------------------------------------------------------
    // 4Ô∏è‚É£ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Login / OTP / ‡∏à‡∏≠‡∏á‡∏ï‡∏π‡πâ)
    // ---------------------------------------------------------
    function renderRecaptcha() {
        if (!window.recaptchaVerifier) {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'normal',
                'callback': (response) => { /* Captcha ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß */ }
            });
            window.recaptchaVerifier.render();
        }
    }

    function sendOTP() {
        const phoneNumber = document.getElementById('loginPhone').value;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
        if (phoneNumber.length < 10 || !phoneNumber.startsWith('+')) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ +66...)");
            return;
        }

        const btn = event.target;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
        btn.disabled = true;

        const appVerifier = window.recaptchaVerifier;
        auth.signInWithPhoneNumber(phoneNumber, appVerifier)
            .then((result) => {
                confirmationResult = result;
                alert("‚úÖ ‡∏™‡πà‡∏á SMS ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                document.getElementById('pageLogin').classList.add('hidden');
                document.getElementById('pageOTP').classList.remove('hidden');
                btn.innerText = "‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ OTP";
                btn.disabled = false;
            }).catch((error) => {
                console.error(error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
                btn.innerText = "‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ OTP";
                btn.disabled = false;
                if(window.recaptchaWidgetId) grecaptcha.reset(window.recaptchaWidgetId);
            });
    }

    function verifyOTP() {
        const code = document.getElementById('otpInput').value;
        if(!confirmationResult) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ OTP ‡∏Å‡πà‡∏≠‡∏ô");
        
        confirmationResult.confirm(code).then((result) => {
            // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà auth.onAuthStateChanged ‡πÄ‡∏≠‡∏á
            alert("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!");
        }).catch((error) => {
            alert("‚ùå ‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        });
    }

    function logout() {
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) {
            auth.signOut().then(() => {
                window.location.href = window.location.pathname; // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
            });
        }
    }

    // ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    function nav(pageName) {
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤
        ['pageMenu', 'pageSender', 'pageReceiver'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        });

        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        if (pageName === 'menu') document.getElementById('pageMenu').classList.remove('hidden');
        if (pageName === 'sender') {
            document.getElementById('pageSender').classList.remove('hidden');
            loadLockers(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà
        }
        if (pageName === 'receiver') {
            document.getElementById('pageReceiver').classList.remove('hidden');
            document.getElementById('resultBox').innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Å‡πà‡∏≤
            document.getElementById('sPhone').value = "";
        }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏π‡πâ
    async function loadLockers() {
        const grid = document.getElementById('lockerGrid');
        grid.innerHTML = "<p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>";
        
        try {
            const res = await fetch(API_URL + "?action=checkStatus");
            const data = await res.json();
            grid.innerHTML = "";
            
            data.forEach(item => {
                let btn = document.createElement('button');
                let isFree = item.status === 'Available';
                
                btn.className = `l-btn ${isFree ? 'available' : 'occupied'}`;
                btn.innerHTML = `‡∏ï‡∏π‡πâ ${item.locker}<br><span>${isFree ? '‡∏ß‡πà‡∏≤‡∏á' : '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á'}</span>`;
                btn.disabled = !isFree;

                if (isFree) {
                    btn.onclick = () => {
                        selectedLocker = item.locker;
                        document.getElementById('targetLocker').innerText = item.locker;
                        document.getElementById('reserveForm').classList.remove('hidden');
                        document.getElementById('reserveForm').scrollIntoView({behavior: 'smooth'});
                    };
                }
                grid.appendChild(btn);
            });
        } catch (error) {
            console.error(error);
            grid.innerHTML = "<p style='color:red'>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>";
        }
    }

    // ‡∏à‡∏≠‡∏á‡∏ï‡∏π‡πâ
    async function doReserve() {
        const phoneReceiver = document.getElementById('rPhone').value;
        if (phoneReceiver.length < 4) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö");

        const btn = event.target;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        btn.disabled = true;

        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'reserve',
                    locker: selectedLocker,
                    phone: phoneReceiver,
                    sender: currentUserPhone
                })
            });
            alert("‚úÖ ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            nav('menu');
        } catch (error) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        }
        btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å";
        btn.disabled = false;
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏
    async function doSearch() {
        const searchPhone = document.getElementById('sPhone').value;
        const resultBox = document.getElementById('resultBox');
        
        if (!searchPhone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå");

        resultBox.innerHTML = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
        try {
            const res = await fetch(`${API_URL}?action=find&phone=${searchPhone}`);
            const data = await res.json();

            if (data.found) {
                resultBox.innerHTML = `
                    <div style="background:#e8f5e9; padding:15px; border-radius:8px; margin-top:10px; text-align:center;">
                        <h3 style="color:green; margin:0;">üéâ ‡∏°‡∏µ‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏∏‡∏ì!</h3>
                        <p style="font-size:1.2em;">‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà <b>‡∏ï‡∏π‡πâ ${data.locker}</b></p>
                        <button onclick="doClear('${data.locker}')" class="btn-confirm" style="width:100%; margin-top:10px;">‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</button>
                    </div>`;
            } else {
                resultBox.innerHTML = `<div style="background:#ffebee; padding:15px; border-radius:8px; margin-top:10px; text-align:center; color:red;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏</div>`;
            }
        } catch (error) {
            resultBox.innerHTML = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
        }
    }

    // ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏π‡πâ)
    async function doClear(lockerName) {
        if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏π‡πâ ${lockerName}?`)) return;

        await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'clear', locker: lockerName })
        });
        alert("üéâ ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß");
        nav('menu');
    }
</script>
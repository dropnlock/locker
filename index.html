<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Locker - Firebase Auth</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 420px; text-align: center; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; font-size: 24px; margin-bottom: 10px; }
        p { color: #666; font-size: 14px; margin-bottom: 20px; }
        input { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #ecf0f1; border-radius: 10px; font-size: 16px; text-align: center; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus { border-color: #3498db; }
        button { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; font-size: 16px; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-main { background: #2c3e50; } .btn-confirm { background: #27ae60; } .btn-sender { background: #e67e22; } .btn-receiver { background: #3498db; }
        .hidden { display: none; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .l-btn { padding: 15px; border-radius: 10px; border: 2px solid #eee; background: white; font-size: 14px; transition: 0.2s; }
        .available { background: #e8f5e9; color: #27ae60; border-color: #2ecc71; cursor: pointer; }
        .available:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.2); }
        .occupied { background: #ffebee; color: #c0392b; border-color: #e74c3c; cursor: not-allowed; opacity: 0.6; }
        /* Recaptcha Container */
        #recaptcha-container { margin: 15px auto; display: flex; justify-content: center; }
    </style>
</head>
<body>

<div class="container">
    <div id="pageLogin" class="card">
        <h1>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>
        <p>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏ü‡∏£‡∏µ)</p>
        <input type="tel" id="loginPhone" placeholder="+66812345678" value="+66">
        
        <div id="recaptcha-container"></div>
        
        <button class="btn-main" onclick="sendOTP()">üì© ‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ OTP (SMS)</button>
    </div>

    <div id="pageOTP" class="card hidden">
        <h1>üí¨ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h1>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏≤‡∏á SMS</p>
        <input type="text" id="otpInput" placeholder="xxxxxx" maxlength="6">
        <button class="btn-confirm" onclick="verifyOTP()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
        <button onclick="location.reload()" style="background:none; color:#999; margin-top:10px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå</button>
    </div>

    <div id="pageMenu" class="card hidden">
        <h1>üì¶ Smart Locker</h1>
        <p id="welcomeUser"></p>
        <button class="btn-sender" onclick="nav('sender')">üöö ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á)</button>
        <button class="btn-receiver" onclick="nav('receiver')">üéÅ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á)</button>
        <button onclick="logout()" style="background:none; color:#999; margin-top:15px;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="pageSender" class="card hidden">
        <div style="text-align:left;"><button onclick="nav('menu')" style="background:none; color:#999; margin:0;">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button></div>
        <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</h2>
        <div id="lockerGrid" class="grid">Loading...</div>
        <div id="reserveForm" class="hidden" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <p>‡∏ù‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏π‡πâ: <b id="targetLocker" style="color:#e67e22; font-size:20px;"></b></p>
            <input type="tel" id="rPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢)" maxlength="4">
            <button class="btn-confirm" onclick="doReserve()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å</button>
        </div>
    </div>

    <div id="pageReceiver" class="card hidden">
        <div style="text-align:left;"><button onclick="nav('menu')" style="background:none; color:#999; margin:0;">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button></div>
        <h2>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏</h2>
        <input type="tel" id="sPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢)" maxlength="4">
        <button class="btn-receiver" onclick="doSearch()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <div id="resultBox" style="margin-top:15px;"></div>
    </div>
</div>

<script>
    // ‚úÖ 1. ‡πÉ‡∏™‡πà Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
    const firebaseConfig = {
      apiKey: "AIzaSyDnPenoLXFdVPtUUR3z9lQACAeS6WZcyyU",
      authDomain: "dropnlock-b9699.firebaseapp.com",
      projectId: "dropnlock-b9699",
      storageBucket: "dropnlock-b9699.firebasestorage.app",
      messagingSenderId: "971185135920",
      appId: "1:971185135920:web:f208fe01f1773d257428f5",
      measurementId: "G-JV5HQTG9FB"
    };

    // ‚úÖ 2. ‡πÉ‡∏™‡πà URL Apps Script ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß
    const API_URL = "https://script.google.com/macros/s/AKfycby5p-MrPS_NcSz0GSEcy5FrMfnZRB5MYrw66bWjTGeVBowfd-nXwZTUPlGA_gbS0dQUCg/exec";

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    auth.languageCode = 'th'; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SMS ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢

    let confirmationResult = null;
    let currentUserPhone = "";
    let selectedLocker = null;

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Recaptcha (‡∏Å‡∏±‡∏ô‡∏ö‡∏≠‡∏ó)
    window.onload = function() {
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            'size': 'normal',
            'callback': (response) => {
                // reCAPTCHA solved
            }
        });
        window.recaptchaVerifier.render();
    };

    function sendOTP() {
        const phoneNumber = document.getElementById('loginPhone').value;
        const appVerifier = window.recaptchaVerifier;

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ +66 ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        if(phoneNumber.length < 10 || !phoneNumber.startsWith('+')) {
            return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (+66...)");
        }

        const btn = event.target;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á SMS...";
        btn.disabled = true;

        auth.signInWithPhoneNumber(phoneNumber, appVerifier)
            .then((result) => {
                confirmationResult = result;
                alert("‚úÖ ‡∏™‡πà‡∏á SMS ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà");
                document.getElementById('pageLogin').classList.add('hidden');
                document.getElementById('pageOTP').classList.remove('hidden');
            }).catch((error) => {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
                console.error(error);
                btn.innerText = "üì© ‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ OTP (SMS)";
                btn.disabled = false;
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Recaptcha
                window.recaptchaVerifier.render().then(function(widgetId) {
                  grecaptcha.reset(widgetId);
                });
            });
    }

    function verifyOTP() {
        const code = document.getElementById('otpInput').value;
        confirmationResult.confirm(code).then((result) => {
            const user = result.user;
            currentUserPhone = user.phoneNumber;
            
            document.getElementById('welcomeUser').innerText = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: " + currentUserPhone;
            document.getElementById('pageOTP').classList.add('hidden');
            document.getElementById('pageMenu').classList.remove('hidden');
        }).catch((error) => {
            alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        });
    }

    function logout() {
        auth.signOut().then(() => location.reload());
    }

    /* --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Locker --- */
    function nav(p) {
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        if(p=='menu') document.getElementById('pageMenu').classList.remove('hidden');
        if(p=='sender') { document.getElementById('pageSender').classList.remove('hidden'); loadLockers(); }
        if(p=='receiver') { 
            document.getElementById('pageReceiver').classList.remove('hidden'); 
            document.getElementById('resultBox').innerHTML=""; 
            document.getElementById('sPhone').value="";
        }
    }

    async function loadLockers() {
        const grid = document.getElementById('lockerGrid');
        grid.innerHTML = "Loading...";
        try {
            const res = await fetch(API_URL + "?action=checkStatus");
            const data = await res.json();
            grid.innerHTML = "";
            data.forEach(x => {
                let b = document.createElement('button');
                b.className = `l-btn ${x.status==='Available'?'available':'occupied'}`;
                b.innerHTML = `‡∏ï‡∏π‡πâ ${x.locker}<br>${x.status==='Available'?'‡∏ß‡πà‡∏≤‡∏á':'‡πÄ‡∏ï‡πá‡∏°'}`;
                b.disabled = x.status !== 'Available';
                if(x.status==='Available') b.onclick = () => {
                    selectedLocker = x.locker;
                    document.getElementById('targetLocker').innerText = x.locker;
                    document.getElementById('reserveForm').classList.remove('hidden');
                };
                grid.appendChild(b);
            });
        } catch(e) { grid.innerHTML = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡πÄ‡∏ä‡πá‡∏Ñ URL App Script)"; }
    }

    async function doReserve() {
        const ph = document.getElementById('rPhone').value;
        if(ph.length < 4) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        
        const btn = event.target;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        btn.disabled = true;

        await fetch(API_URL, { 
            method:'POST', 
            body:JSON.stringify({
                action:'reserve', 
                locker:selectedLocker, 
                phone:ph,
                sender: currentUserPhone 
            }) 
        });
        alert("‚úÖ ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); 
        nav('menu');
        btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å";
        btn.disabled = false;
    }

    async function doSearch() {
        const ph = document.getElementById('sPhone').value;
        const box = document.getElementById('resultBox');
        box.innerHTML = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";

        const res = await fetch(`${API_URL}?action=find&phone=${ph}`);
        const d = await res.json();
        
        if(d.found) {
            box.innerHTML = `
                <div style="background:#e8f5e9; padding:15px; border-radius:10px; border:1px solid #c8e6c9;">
                    <h3 style="color:#2e7d32; margin-top:0;">üéâ ‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏!</h3>
                    <p>‡∏Ç‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà <b>‡∏ï‡∏π‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${d.locker}</b></p>
                    <button onclick="doClear('${d.locker}')" class="btn-confirm">üì¶ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏π‡πâ)</button>
                </div>`;
        } else {
            box.innerHTML = `<div style="background:#ffebee; padding:15px; border-radius:10px; color:#c62828;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</div>`;
        }
    }

    async function doClear(n) {
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß?")) return;
        await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'clear', locker:n}) });
        alert("üéâ ‡∏ï‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß"); 
        nav('menu');
    }
</script>

</body>
</html>
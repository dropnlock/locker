<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Locker - OTP Email</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á --- */
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 420px; text-align: center; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { color: #2c3e50; font-size: 24px; margin-bottom: 10px; }
        p { color: #666; font-size: 14px; margin-bottom: 20px; }
        
        input { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #ecf0f1; border-radius: 10px; font-size: 16px; text-align: center; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus { border-color: #3498db; }
        
        button { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; font-size: 16px; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        
        .btn-main { background: #2c3e50; }
        .btn-confirm { background: #27ae60; }
        .btn-sender { background: #e67e22; }
        .btn-receiver { background: #3498db; }
        .btn-back { background: transparent; color: #999; width: auto; font-size: 14px; margin-top: 15px; }

        .hidden { display: none; }
        
        /* Grid ‡∏ï‡∏π‡πâ */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .l-btn { padding: 15px; border-radius: 10px; border: 2px solid #eee; background: white; font-size: 14px; transition: 0.2s; }
        .available { background: #e8f5e9; color: #27ae60; border-color: #2ecc71; cursor: pointer; }
        .available:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.2); }
        .occupied { background: #ffebee; color: #c0392b; border-color: #e74c3c; cursor: not-allowed; opacity: 0.6; }

        /* ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå */
        .res-box { margin-top: 15px; padding: 15px; border-radius: 10px; animation: fadeIn 0.3s; }
    </style>
</head>
<body>

<div class="container">

    <div id="pageLogin" class="card">
        <h1> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ OTP</p>
        <input type="email" id="loginEmail" placeholder="example@gmail.com">
        <button class="btn-main" onclick="sendOTP()"> ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
    </div>

    <div id="pageOTP" class="card hidden">
        <h1> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h1>
        <p>‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß<br>(‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô Inbox ‡∏´‡∏£‡∏∑‡∏≠ Junk Mail)</p>
        <input type="text" id="otpInput" placeholder="‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å" maxlength="6">
        <button class="btn-confirm" onclick="verifyOTP()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
        <button class="btn-back" onclick="location.reload()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>

    <div id="pageMenu" class="card hidden">
        <h1> DropNLock</h1>
        <p id="welcomeUser"></p>
        <button class="btn-sender" onclick="nav('sender')"> ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á)</button>
        <button class="btn-receiver" onclick="nav('receiver')"> ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á)</button>
        <button class="btn-back" onclick="location.reload()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="pageSender" class="card hidden">
        <div style="text-align:left;"><button class="btn-back" style="margin:0;" onclick="nav('menu')">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button></div>
        <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</h2>
        <div id="lockerGrid" class="grid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        
        <div id="reserveForm" class="hidden" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <p>‡∏ù‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏π‡πâ: <b id="targetLocker" style="color:#e67e22; font-size:20px;"></b></p>
            <input type="tel" id="rPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢)" maxlength="4">
            <button class="btn-confirm" onclick="doReserve()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å</button>
        </div>
    </div>

    <div id="pageReceiver" class="card hidden">
        <div style="text-align:left;"><button class="btn-back" style="margin:0;" onclick="nav('menu')">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button></div>
        <h2> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏</h2>
        <input type="tel" id="sPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢)" maxlength="4">
        <button class="btn-receiver" onclick="doSearch()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <div id="searchResult"></div>
    </div>

</div>

<script>
    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö
    const API_URL = "https://script.google.com/macros/s/AKfycbxt4gd07QZNE8VVkKe2rBgdto7M8-uZaFlDl3c6QRMLEi-8ARXtZwkgmyaPCYgBOXkCSQ/exec";

    let currentEmail = "";
    let selectedLocker = null;

    /* --- ‡∏™‡πà‡∏ß‡∏ô Login OTP --- */
    async function sendOTP() {
        const email = document.getElementById('loginEmail').value;
        if(!email.includes("@")) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

        const btn = event.target;
        btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•...";
        btn.disabled = true;

        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'sendOTP', email: email })
            });
            currentEmail = email;
            alert("‚úÖ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞/Spam)");
            document.getElementById('pageLogin').classList.add('hidden');
            document.getElementById('pageOTP').classList.remove('hidden');
        } catch(e) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏°‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏´‡∏£‡∏∑‡∏≠ Deploy ‡πÉ‡∏´‡∏°‡πà");
            btn.innerText = " ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•";
            btn.disabled = false;
        }
    }

    async function verifyOTP() {
        const otp = document.getElementById('otpInput').value;
        const btn = event.target;
        btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
        
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'verifyOTP', email: currentEmail, otp: otp })
            });
            const data = await res.json();
            
            if (data.status === 'success') {
                document.getElementById('welcomeUser').innerText = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: " + currentEmail;
                document.getElementById('pageOTP').classList.add('hidden');
                document.getElementById('pageMenu').classList.remove('hidden');
            } else {
                alert(" ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™";
            }
        } catch(e) { alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"); }
    }

    /* --- ‡∏™‡πà‡∏ß‡∏ô Locker System --- */
    function nav(p) {
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        if(p=='menu') document.getElementById('pageMenu').classList.remove('hidden');
        if(p=='sender') { document.getElementById('pageSender').classList.remove('hidden'); loadLockers(); }
        if(p=='receiver') { 
            document.getElementById('pageReceiver').classList.remove('hidden'); 
            document.getElementById('searchResult').innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡πÄ‡∏Å‡πà‡∏≤
            document.getElementById('sPhone').value = "";
        }
    }

    async function loadLockers() {
        const grid = document.getElementById('lockerGrid');
        grid.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        try {
            const res = await fetch(API_URL + "?action=checkStatus");
            const data = await res.json();
            grid.innerHTML = "";
            data.forEach(x => {
                let b = document.createElement('button');
                b.className = `l-btn ${x.status==='Available'?'available':'occupied'}`;
                b.innerHTML = `‡∏ï‡∏π‡πâ ${x.locker}<br>${x.status==='Available'?'‡∏ß‡πà‡∏≤‡∏á':'‡πÄ‡∏ï‡πá‡∏°'}`;
                b.disabled = x.status !== 'Available';
                if(x.status==='Available') {
                    b.onclick = () => {
                        selectedLocker = x.locker;
                        document.getElementById('targetLocker').innerText = x.locker;
                        document.getElementById('reserveForm').classList.remove('hidden');
                    };
                }
                grid.appendChild(b);
            });
        } catch(e) { grid.innerHTML = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡πÄ‡∏ä‡πá‡∏Ñ URL / ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Anyone)"; }
    }

    async function doReserve() {
        const ph = document.getElementById('rPhone').value;
        if(ph.length < 4) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏ï‡∏±‡∏ß");
        
        const btn = event.target;
        const oldText = btn.innerText;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        btn.disabled = true;

        try {
            await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'reserve', locker:selectedLocker, phone:ph}) });
            alert(" ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); 
            nav('menu');
        } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
        
        btn.innerText = oldText;
        btn.disabled = false;
    }

    async function doSearch() {
        const ph = document.getElementById('sPhone').value;
        const box = document.getElementById('searchResult');
        box.innerHTML = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
        
        try {
            const res = await fetch(`${API_URL}?action=find&phone=${ph}`);
            const d = await res.json();
            
            if(d.found) {
                box.innerHTML = `
                    <div class="res-box" style="background:#e8f5e9; border:1px solid #c8e6c9;">
                        <h3 style="color:#2e7d32; margin-top:0;"> ‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏!</h3>
                        <p>‡∏Ç‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà <b>‡∏ï‡∏π‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${d.locker}</b></p>
                        <button class="btn-confirm" onclick="doClear('${d.locker}')"> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏π‡πâ)</button>
                    </div>`;
            } else {
                box.innerHTML = `<div class="res-box" style="background:#ffebee; color:#c62828;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</div>`;
            }
        } catch(e) { box.innerHTML = "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"; }
    }

    async function doClear(n) {
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á")) return;
        await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'clear', locker:n}) });
        alert(" ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏ï‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß");
        nav('menu');
    }
</script>

</body>
</html>
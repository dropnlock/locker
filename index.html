<script>
    // ==========================================
    // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Config (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDnPenoLXFdVPtUUR3z9lQACAeS6WZcyyU",
        authDomain: "dropnlock-b9699.firebaseapp.com",
        projectId: "dropnlock-b9699",
        storageBucket: "dropnlock-b9699.firebasestorage.app",
        messagingSenderId: "971185135920",
        appId: "1:971185135920:web:f208fe01f1773d257428f5",
        measurementId: "G-JV5HQTG9FB"
    };

    // ‡πÉ‡∏™‡πà URL Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    const API_URL = "https://script.google.com/macros/s/AKfycby5p-MrPS_NcSz0GSEcy5FrMfnZRB5MYrw66bWjTGeVBowfd-nXwZTUPlGA_gbS0dQUCg/exec";

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    auth.languageCode = 'th';

    // ==========================================
    // üî• 2. ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÅ‡∏¢‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏£‡∏´‡∏±‡∏™ (LINE vs Web)
    // ==========================================
    const isLineApp = /Line/i.test(navigator.userAgent); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô LINE -> ‡πÉ‡∏´‡πâ‡∏à‡∏≥‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ (LOCAL)
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ -> ‡πÉ‡∏´‡πâ‡∏à‡∏≥‡πÅ‡∏Ñ‡πà‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏∑‡∏° (SESSION)
    const persistenceMode = isLineApp 
        ? firebase.auth.Auth.Persistence.LOCAL 
        : firebase.auth.Auth.Persistence.SESSION;

    auth.setPersistence(persistenceMode)
        .then(() => console.log("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏õ‡πá‡∏ô: " + (isLineApp ? "‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ (LINE)" : "‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (Web)")))
        .catch((err) => console.error("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Persistence ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err));

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
    let confirmationResult = null;
    let currentUserPhone = "";
    let selectedLocker = null;

    // ==========================================
    // üî• 3. ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
    // ==========================================
    auth.onAuthStateChanged((user) => {
        if (user) {
            // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ---
            currentUserPhone = user.phoneNumber;
            console.log("Logged in as:", currentUserPhone);
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Login / OTP
            document.getElementById('pageLogin').classList.add('hidden');
            document.getElementById('pageOTP').classList.add('hidden');
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            const welcomeUser = document.getElementById('welcomeUser');
            if(welcomeUser) welcomeUser.innerText = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: " + currentUserPhone;

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏´‡∏ô? (Deep Link)
            checkDeepLink(); 
        } else {
            // --- ‡∏Å‡∏£‡∏ì‡∏µ "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏•‡∏∏‡∏î" ---
            document.getElementById('pageLogin').classList.remove('hidden');
            document.getElementById('pageOTP').classList.add('hidden');
            document.getElementById('pageMenu').classList.add('hidden');
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Recaptcha ‡∏£‡∏≠‡πÑ‡∏ß‡πâ
            renderRecaptcha();
        }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏´‡∏ô (Sender / Receiver)
    function checkDeepLink() {
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page'); // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ ?page=... ‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå

        if (page === 'sender') {
            nav('sender'); // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏ï‡∏π‡πâ
        } else if (page === 'receiver') {
            nav('receiver'); // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        } else {
            nav('menu'); // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏Å‡∏ï‡∏¥
        }
    }

    // ==========================================
    // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° (Login / OTP / ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
    // ==========================================
    function renderRecaptcha() {
        if(!document.getElementById('recaptcha-container').hasChildNodes()) {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'normal',
                'callback': (response) => { /* solved */ }
            });
            window.recaptchaVerifier.render();
        }
    }

    function sendOTP() {
        const phoneNumber = document.getElementById('loginPhone').value;
        const appVerifier = window.recaptchaVerifier;

        if(phoneNumber.length < 10 || !phoneNumber.startsWith('+')) {
            return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡πÄ‡∏ä‡πà‡∏ô +6681...)");
        }

        const btn = event.target;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á SMS...";
        btn.disabled = true;

        auth.signInWithPhoneNumber(phoneNumber, appVerifier)
            .then((result) => {
                confirmationResult = result;
                alert("‚úÖ ‡∏™‡πà‡∏á SMS ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°");
                document.getElementById('pageLogin').classList.add('hidden');
                document.getElementById('pageOTP').classList.remove('hidden');
                btn.innerText = "‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ OTP";
                btn.disabled = false;
            }).catch((error) => {
                console.error(error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
                btn.innerText = "‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ OTP";
                btn.disabled = false;
                if(window.recaptchaWidgetId) grecaptcha.reset(window.recaptchaWidgetId);
            });
    }

    function verifyOTP() {
        const code = document.getElementById('otpInput').value;
        confirmationResult.confirm(code).then((result) => {
            // ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -> onAuthStateChanged ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏≠‡∏á
        }).catch((error) => {
            alert("‚ùå ‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        });
    }

    function logout() {
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) {
            auth.signOut().then(() => {
                window.location.href = window.location.pathname; // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
            });
        }
    }

    // ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (Navigation)
    function nav(p) {
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô
        document.getElementById('pageMenu').classList.add('hidden');
        document.getElementById('pageSender').classList.add('hidden');
        document.getElementById('pageReceiver').classList.add('hidden');

        // ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        if(p=='menu') document.getElementById('pageMenu').classList.remove('hidden');
        if(p=='sender') { 
            document.getElementById('pageSender').classList.remove('hidden'); 
            loadLockers(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏π‡πâ
        }
        if(p=='receiver') { 
            document.getElementById('pageReceiver').classList.remove('hidden'); 
            document.getElementById('resultBox').innerHTML=""; 
            document.getElementById('sPhone').value="";
        }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏π‡πâ (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Apps Script)
    async function loadLockers() {
        const grid = document.getElementById('lockerGrid');
        grid.innerHTML = "<p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏π‡πâ...</p>";
        try {
            const res = await fetch(API_URL + "?action=checkStatus");
            const data = await res.json();
            grid.innerHTML = "";
            data.forEach(x => {
                let b = document.createElement('button');
                b.className = `l-btn ${x.status==='Available'?'available':'occupied'}`;
                b.innerHTML = `‡∏ï‡∏π‡πâ ${x.locker}<br><span>${x.status==='Available'?'‡∏ß‡πà‡∏≤‡∏á':'‡πÄ‡∏ï‡πá‡∏°'}</span>`;
                b.disabled = x.status !== 'Available';
                
                if(x.status==='Available') {
                    b.onclick = () => {
                        selectedLocker = x.locker;
                        document.getElementById('targetLocker').innerText = x.locker;
                        document.getElementById('reserveForm').classList.remove('hidden');
                        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏•‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°
                        document.getElementById('reserveForm').scrollIntoView({behavior: 'smooth'});
                    };
                }
                grid.appendChild(b);
            });
        } catch(e) { 
            console.error(e);
            grid.innerHTML = "<p style='color:red'>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>"; 
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≠‡∏á‡∏ï‡∏π‡πâ
    async function doReserve() {
        const ph = document.getElementById('rPhone').value;
        if(ph.length < 4) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö");
        
        const btn = event.target;
        const oldText = btn.innerText;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; 
        btn.disabled = true;

        try {
            await fetch(API_URL, { 
                method:'POST', 
                body:JSON.stringify({
                    action:'reserve', 
                    locker:selectedLocker, 
                    phone:ph, 
                    sender: currentUserPhone 
                }) 
            });
            alert("‚úÖ ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); 
            nav('menu');
        } catch(e) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        }
        btn.innerText = oldText; 
        btn.disabled = false;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏
    async function doSearch() {
        const ph = document.getElementById('sPhone').value;
        const box = document.getElementById('resultBox');
        
        if(!ph) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå");

        box.innerHTML = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
        try {
            const res = await fetch(`${API_URL}?action=find&phone=${ph}`);
            const d = await res.json();
            
            if(d.found) {
                box.innerHTML = `
                    <div style="background:#e8f5e9; padding:15px; border-radius:10px; margin-top:10px; text-align:center;">
                        <h3 style="color:#2e7d32; margin:0;">üéâ ‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô!</h3>
                        <p style="font-size:18px;">‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà <b>‡∏ï‡∏π‡πâ ${d.locker}</b></p>
                        <button onclick="doClear('${d.locker}')" class="btn-confirm" style="width:100%; margin-top:10px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏π‡πâ)</button>
                    </div>`;
            } else {
                box.innerHTML = `<div style="background:#ffebee; padding:15px; border-radius:10px; margin-top:10px; text-align:center; color:#c62828;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ</div>`;
            }
        } catch(e) {
            box.innerHTML = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏π‡πâ (‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á)
    async function doClear(n) {
        if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏π‡πâ ${n}?`)) return;
        
        await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'clear', locker:n}) });
        alert("üéâ ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏ï‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß!"); 
        nav('menu');
    }
</script>